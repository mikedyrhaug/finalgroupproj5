---
title: "tslm_take_3"
author: "Me"
date: "3/28/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Time Series Regression

[Adam's notes](https://docs.google.com/document/d/1mtfrCWF1twr3AJCevaNGE7VEYalCOkN1Y4qsFPTjnek/edit?usp=sharing)

```{r message=FALSE}
library(fpp3)
library(lubridate)
```

```{r}
data_url <- "https://docs.google.com/spreadsheets/d/1Q6utXvc_tTNzfU-fnERWBngaK-06oAKXinlSFSjfJs8/export?format=csv"

avocado <- read.csv(data_url) %>%
  mutate(month = yearmonth(month)) %>%
  as_tsibble(index = month)

names(avocado) <- c(
  "month", "price_conv", "price_org",
  "volume_conv", "volume_org"
)

head(avocado, 3)
```

* Plot the entire series
* What useful insights are there (with an eye towards forecasting)

```{r}
avocado %>% 
  autoplot(volume_org)
```

* Create plot(s) to investigate seasonality

```{r}
avocado %>% 
  gg_season(volume_org)

```

* Which variable seems to be the best predictor of `volume_org`

```{r}
pairs(avocado[,-1])
```

* Fit a TSLM using just using the single best predictor of `volume_org`
* Report on the fit
  * How much variation explained?
  * Is it a significant predictor?
  * Interpret coefficient

```{r}
fit <- avocado %>% 
  model(TSLM(volume_org ~ volume_conv))

report(fit)
```

* What "special" time series variable do you think would be the best predictor of `volume_org`
* Fit a TSLM using just using the single best predictor `volume_org`
* Report on the fit
  * How much variation explained?
  * Is it a significant predictor?
  * Interpret coefficient

```{r}
fit <- avocado %>% 
  model(TSLM(volume_org ~ trend()))

report(fit)
```

* Fit multiple models:
  1. Using just variables in the dataframe
  2. Using just "special" time series variables
  3. A mix of both
* Compare the models to choose the best one

```{r}
fit <- avocado %>% 
  model(
    m1 = TSLM(volume_org ~ volume_conv + price_org),
    m2 = TSLM(volume_org ~ trend() + season()),
    m3 = TSLM(volume_org ~ volume_conv + trend() + season()),
  )

glance(fit) %>% 
  arrange(AIC)
```

* Extract the best fitting model and investigate it's residuals
  * Do this visually
  * Perform a ljung-box test
    * What does this test for?
    
```{r}
best_fit <- fit %>% 
  select(m3)
gg_tsresiduals(best_fit)

augment(best_fit) %>% 
  features(.innov, ljung_box)
```

* Plot the fitted model

```{r}
best_fit %>% 
  forecast(avocado) %>% 
  autoplot(avocado)
```

* Generate prediction intervals using the `hilo()` function
* Pipe the results into the `expand_hilo()` helper to display in .Rmd
* `select()` down to just month, .mean, and the 95% CI

```{r}
# This helper will also be provided on the homework
expand_hilo <- function(tbl) {
  tbl %>%
    mutate(
      across(
        distributional::is_hilo,
        .fns = list(
          lower = function(x) x$lower,
          upper = function(x) x$upper
        )
      )
    ) %>%
    select(where(~ !distributional::is_hilo(.x))) %>%
    select(where(~ !distributional::is_distribution(.x)))
}

pred_intervals <- best_fit %>% 
  forecast(avocado) %>% 
  hilo() %>% 
  expand_hilo()

pred_intervals %>% 
  select(month, .mean, `95%_lower`, `95%_upper`)
```

* Create a forecasting model using just special ts vars
* Investigate the fit and residuals
* Generate a forecast for the next year of observations
* Plot the forecast and the original data
* Is the forecast believable?

```{r}
fit <- avocado %>% 
  model(
    m1 = TSLM(volume_org ~ trend() + season()),
    m2 = TSLM(volume_org ~ trend() + fourier(K = 1)),
    m3 = TSLM(volume_org ~ trend() + fourier(K = 3))
  )
fit %>% 
  glance() %>% 
  arrange(AIC)

best_fit <- fit %>% 
  select(m2)

gg_tsresiduals(best_fit)

augment(best_fit) %>% 
  features(.innov, ljung_box)

best_fit %>% 
  forecast(h = '5 years') %>% 
  autoplot(avocado)

```
